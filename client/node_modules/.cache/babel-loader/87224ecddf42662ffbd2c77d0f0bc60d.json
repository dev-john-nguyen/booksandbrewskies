{"ast":null,"code":"import _defineProperty from\"C:\\\\Users\\\\John\\\\Desktop\\\\Modern React With Redux Projects\\\\beersandbrewskiesproject\\\\booksandbrewskies\\\\client\\\\node_modules\\\\@babel\\\\runtime/helpers/esm/defineProperty\";import _regeneratorRuntime from\"C:\\\\Users\\\\John\\\\Desktop\\\\Modern React With Redux Projects\\\\beersandbrewskiesproject\\\\booksandbrewskies\\\\client\\\\node_modules\\\\@babel\\\\runtime/regenerator\";import _classCallCheck from\"C:\\\\Users\\\\John\\\\Desktop\\\\Modern React With Redux Projects\\\\beersandbrewskiesproject\\\\booksandbrewskies\\\\client\\\\node_modules\\\\@babel\\\\runtime/helpers/esm/classCallCheck\";import _createClass from\"C:\\\\Users\\\\John\\\\Desktop\\\\Modern React With Redux Projects\\\\beersandbrewskiesproject\\\\booksandbrewskies\\\\client\\\\node_modules\\\\@babel\\\\runtime/helpers/esm/createClass\";import _possibleConstructorReturn from\"C:\\\\Users\\\\John\\\\Desktop\\\\Modern React With Redux Projects\\\\beersandbrewskiesproject\\\\booksandbrewskies\\\\client\\\\node_modules\\\\@babel\\\\runtime/helpers/esm/possibleConstructorReturn\";import _getPrototypeOf from\"C:\\\\Users\\\\John\\\\Desktop\\\\Modern React With Redux Projects\\\\beersandbrewskiesproject\\\\booksandbrewskies\\\\client\\\\node_modules\\\\@babel\\\\runtime/helpers/esm/getPrototypeOf\";import _inherits from\"C:\\\\Users\\\\John\\\\Desktop\\\\Modern React With Redux Projects\\\\beersandbrewskiesproject\\\\booksandbrewskies\\\\client\\\\node_modules\\\\@babel\\\\runtime/helpers/esm/inherits\";import React from'react';import{ElementsConsumer,CardElement}from'@stripe/react-stripe-js';import{connect}from'react-redux';import CardSection from'./components/CardSection';import IdentitySection from'./components/IdentitySection';import AddressSection from'./components/AddressSection';import'./css/CheckoutFormStyles.css';import Spinner from'../../../spinner';import CartSection from'./components/CartSection';import{formatPrice,getSessionStorageUpdateCart}from'../util';import{getStripe,storeOrder}from'../../../../services/order/actions';import{clearCart}from'../../../../services/cart/actions';import{clearCartTotal}from'../../../../services/total/actions';import history from'../../../../history';import Mymodal from'../../../Modal';import{Modal}from'react-bootstrap';var CheckoutForm=/*#__PURE__*/function(_React$Component){_inherits(CheckoutForm,_React$Component);function CheckoutForm(){var _getPrototypeOf2;var _this;_classCallCheck(this,CheckoutForm);for(var _len=arguments.length,args=new Array(_len),_key=0;_key<_len;_key++){args[_key]=arguments[_key];}_this=_possibleConstructorReturn(this,(_getPrototypeOf2=_getPrototypeOf(CheckoutForm)).call.apply(_getPrototypeOf2,[this].concat(args)));_this.state={name:'',email:'',phone:'',line1:'',city:'',state:'',zip:'',client_secret:'',session_error:false,order_completed:false,payment_failed:false,orderId:'',buttonLoading:false};_this.componentDidMount=function _callee(){var _this$props,cartTotal,cartProducts,response;return _regeneratorRuntime.async(function _callee$(_context){while(1){switch(_context.prev=_context.next){case 0:_this$props=_this.props,cartTotal=_this$props.cartTotal,cartProducts=_this$props.cartProducts;getSessionStorageUpdateCart(cartProducts,cartTotal);if(!(cartProducts.length>0)){_context.next=13;break;}_context.prev=3;_context.next=6;return _regeneratorRuntime.awrap(getStripe(cartTotal,cartProducts));case 6:response=_context.sent;_context.next=12;break;case 9:_context.prev=9;_context.t0=_context[\"catch\"](3);return _context.abrupt(\"return\",_this.setState({session_error:true}));case 12:if(response.error){_this.setState({session_error:response.error});}else{_this.setState({client_secret:response.data});}case 13:case\"end\":return _context.stop();}}},null,null,[[3,9]]);};_this.handleSubmit=function _callee2(event){var _this$props2,stripe,elements,cartProducts,cartTotal,_this$state,name,phone,email,line1,city,state,zip,client_secret,result,response;return _regeneratorRuntime.async(function _callee2$(_context2){while(1){switch(_context2.prev=_context2.next){case 0:event.preventDefault();//set loading icon on button\n_this.setState({buttonLoading:true});_this$props2=_this.props,stripe=_this$props2.stripe,elements=_this$props2.elements,cartProducts=_this$props2.cartProducts,cartTotal=_this$props2.cartTotal;_this$state=_this.state,name=_this$state.name,phone=_this$state.phone,email=_this$state.email,line1=_this$state.line1,city=_this$state.city,state=_this$state.state,zip=_this$state.zip,client_secret=_this$state.client_secret;if(!(!stripe||!elements)){_context2.next=6;break;}return _context2.abrupt(\"return\");case 6:_context2.prev=6;_context2.next=9;return _regeneratorRuntime.awrap(stripe.confirmCardPayment(client_secret,{payment_method:{card:elements.getElement(CardElement),billing_details:{name:name,phone:phone,email:email}},shipping:{name:name,phone:phone,address:{line1:line1,city:city,state:state,postal_code:zip}}}));case 9:result=_context2.sent;if(!result.error){_context2.next=14;break;}_this.setState({payment_failed:true});_context2.next=21;break;case 14:if(!(result.paymentIntent.status==='succeeded')){_context2.next=21;break;}_context2.next=17;return _regeneratorRuntime.awrap(storeOrder(result.paymentIntent,cartProducts,cartTotal,name,phone,email));case 17:response=_context2.sent;if(response.data){sessionStorage.removeItem('cartTotal');sessionStorage.removeItem('cartProducts');_this.setState({order_completed:true,orderId:response.data.chargeId});}else{//failed to store order into database\n//handle field to store order into the database\n//It's already in stripe\n//Send antoher request to database indicating it failed\n}_context2.next=21;break;case 21:_context2.next=27;break;case 23:_context2.prev=23;_context2.t0=_context2[\"catch\"](6);console.log(_context2.t0);_this.setState({session_error:true});case 27:case\"end\":return _context2.stop();}}},null,null,[[6,23]]);};_this.handleInputChange=function(event){var target=event.target;var value=target.value;var name=target.name;_this.setState(_defineProperty({},name,value));};return _this;}_createClass(CheckoutForm,[{key:\"render\",value:function render(){var _this2=this;var _this$state2=this.state,name=_this$state2.name,phone=_this$state2.phone,email=_this$state2.email,line1=_this$state2.line1,city=_this$state2.city,state=_this$state2.state,zip=_this$state2.zip,client_secret=_this$state2.client_secret,session_error=_this$state2.session_error,order_completed=_this$state2.order_completed,orderId=_this$state2.orderId,buttonLoading=_this$state2.buttonLoading,payment_failed=_this$state2.payment_failed;var _this$props3=this.props,cartTotal=_this$props3.cartTotal,cartProducts=_this$props3.cartProducts;if(order_completed){var descriptionOrderCompleted=\"Your confirmation number is \".concat(orderId,\".\\n      Check your email for details. If you have any questions or\\n      concerns regarding your order please feel free to contact us.\");return React.createElement(Mymodal,{showValue:true,closeDirect:\"/\",buttonName:\"OK\",title:\"Thank You \".concat(name,\"!\"),description:descriptionOrderCompleted,svgType:\"success\"});}if(cartProducts.length<=0){return React.createElement(Mymodal,{showValue:true,closeDirect:\"/store\",buttonName:\"Store\",title:\"Cart Is Empty\",description:\"Go pick something from our store!\",svgType:\"empty\"});}if(session_error){var clientErrorDescription=\"Looks like something went wrong.\\n      I apologize for the inconvience. No payment was taken\";return React.createElement(Mymodal,{showValue:true,closeDirect:\"/\",buttonName:\"Close\",title:\"Error\",description:clientErrorDescription,svgType:\"error\"});}if(client_secret===''){return React.createElement(Spinner,null);}if(payment_failed){var descriptionOrderFailed=\"Looks like your card has insufficient funds. No payment was taken.\";return React.createElement(Mymodal,{showValue:true,closeDirect:\"/store/checkout\",handleState:function handleState(){return _this2.setState({payment_failed:false,buttonLoading:false});},buttonName:\"Try Again\",title:\"Payment Failed\",description:descriptionOrderFailed,svgType:\"warning\"});}var formatTotalPrice=formatPrice(cartTotal.totalPrice,cartTotal.currencyId);var formStuff=React.createElement(React.Fragment,null,React.createElement(\"div\",{className:\"alert alert-warning alert-dismissible fade show text-center\",role:\"alert\"},React.createElement(\"strong\",null,\"This is for testing purposes. Don't enter your credit card information. Use 4242 4242 4242 4242 04/24 4242 for a successful payment.\"),React.createElement(\"button\",{type:\"button\",className:\"close\",\"data-dismiss\":\"alert\",\"aria-label\":\"Close\"},React.createElement(\"span\",{\"aria-hidden\":\"true\"},\"\\xD7\"))),React.createElement(CartSection,{cartProducts:cartProducts,cartTotal:cartTotal,formatTotalPrice:formatTotalPrice}),React.createElement(\"form\",{onSubmit:this.handleSubmit},React.createElement(IdentitySection,{name:name,phone:phone,email:email,handleInputChange:this.handleInputChange}),React.createElement(AddressSection,{line1:line1,city:city,state:state,zip:zip,handleInputChange:this.handleInputChange}),React.createElement(CardSection,null),React.createElement(\"button\",{className:\"btn btn-primary btn-block\",disabled:!this.props.stripe},buttonLoading&&React.createElement(\"span\",{className:\"spinner-border spinner-border-sm\",role:\"status\",\"aria-hidden\":\"true\"}),\"Confirm To Pay $\",formatTotalPrice)));var walletSvg=React.createElement(\"svg\",{className:\"bi bi-wallet\",style:{position:'relative',bottom:\"5px\"},width:\"3rem\",height:\"3rem\",viewBox:\"0 0 20 20\",fill:\"currentColor\",xmlns:\"http://www.w3.org/2000/svg\"},React.createElement(\"path\",{fillRule:\"evenodd\",d:\"M3.5 5a.5.5 0 00-.5.5v2h5a.5.5 0 01.5.5c0 .253.08.644.306.958.207.288.557.542 1.194.542.637 0 .987-.254 1.194-.542.226-.314.306-.705.306-.958a.5.5 0 01.5-.5h5v-2a.5.5 0 00-.5-.5h-13zM17 8.5h-4.551a2.678 2.678 0 01-.443 1.042c-.393.546-1.043.958-2.006.958-.963 0-1.613-.412-2.006-.958A2.679 2.679 0 017.551 8.5H3v6a.5.5 0 00.5.5h13a.5.5 0 00.5-.5v-6zm-15-3A1.5 1.5 0 013.5 4h13A1.5 1.5 0 0118 5.5v9a1.5 1.5 0 01-1.5 1.5h-13A1.5 1.5 0 012 14.5v-9z\",clipRule:\"evenodd\"}));return React.createElement(Modal,{show:true,onHide:function onHide(){return history.push('/store');},\"aria-labelledby\":\"contained-modal-title-vcenter\",centered:true},React.createElement(Modal.Header,{closeButton:true},React.createElement(Modal.Title,null,React.createElement(\"div\",{className:\"row\"},walletSvg))),React.createElement(Modal.Body,null,formStuff));}}]);return CheckoutForm;}(React.Component);var InjectedCheckoutForm=function InjectedCheckoutForm(_ref){var cartProducts=_ref.cartProducts,cartTotal=_ref.cartTotal,clearCart=_ref.clearCart,clearCartTotal=_ref.clearCartTotal;return React.createElement(ElementsConsumer,null,function(_ref2){var stripe=_ref2.stripe,elements=_ref2.elements;return React.createElement(CheckoutForm,{stripe:stripe,elements:elements,cartProducts:cartProducts,cartTotal:cartTotal,clearCart:clearCart,clearCartTotal:clearCartTotal});});};var mapStateToProps=function mapStateToProps(state){return{cartTotal:state.total.data,cartProducts:state.cart.products};};export default connect(mapStateToProps,{clearCart:clearCart,clearCartTotal:clearCartTotal})(InjectedCheckoutForm);","map":{"version":3,"sources":["C:/Users/John/Desktop/Modern React With Redux Projects/beersandbrewskiesproject/booksandbrewskies/client/src/components/shop/components/checkout/index.js"],"names":["React","ElementsConsumer","CardElement","connect","CardSection","IdentitySection","AddressSection","Spinner","CartSection","formatPrice","getSessionStorageUpdateCart","getStripe","storeOrder","clearCart","clearCartTotal","history","Mymodal","Modal","CheckoutForm","state","name","email","phone","line1","city","zip","client_secret","session_error","order_completed","payment_failed","orderId","buttonLoading","componentDidMount","props","cartTotal","cartProducts","length","response","setState","error","data","handleSubmit","event","preventDefault","stripe","elements","confirmCardPayment","payment_method","card","getElement","billing_details","shipping","address","postal_code","result","paymentIntent","status","sessionStorage","removeItem","chargeId","console","log","handleInputChange","target","value","descriptionOrderCompleted","clientErrorDescription","descriptionOrderFailed","formatTotalPrice","totalPrice","currencyId","formStuff","walletSvg","position","bottom","push","Component","InjectedCheckoutForm","mapStateToProps","total","cart","products"],"mappings":"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","sourcesContent":["import React from 'react';\r\nimport { ElementsConsumer, CardElement } from '@stripe/react-stripe-js';\r\nimport { connect } from 'react-redux';\r\nimport CardSection from './components/CardSection';\r\nimport IdentitySection from './components/IdentitySection';\r\nimport AddressSection from './components/AddressSection';\r\nimport './css/CheckoutFormStyles.css';\r\nimport Spinner from '../../../spinner'\r\nimport CartSection from './components/CartSection';\r\nimport { formatPrice, getSessionStorageUpdateCart } from '../util';\r\nimport { getStripe, storeOrder } from '../../../../services/order/actions';\r\nimport { clearCart } from '../../../../services/cart/actions';\r\nimport { clearCartTotal } from '../../../../services/total/actions';\r\nimport history from '../../../../history';\r\nimport Mymodal from '../../../Modal';\r\nimport { Modal } from 'react-bootstrap';\r\n\r\nclass CheckoutForm extends React.Component {\r\n\r\n  state = {\r\n    name: '',\r\n    email: '',\r\n    phone: '',\r\n    line1: '',\r\n    city: '',\r\n    state: '',\r\n    zip: '',\r\n    client_secret: '',\r\n    session_error: false,\r\n    order_completed: false,\r\n    payment_failed: false,\r\n    orderId: '',\r\n    buttonLoading: false\r\n  }\r\n\r\n  componentDidMount = async () => {\r\n    const { cartTotal, cartProducts } = this.props;\r\n    getSessionStorageUpdateCart(cartProducts, cartTotal);\r\n    if (cartProducts.length > 0) {\r\n\r\n      let response;\r\n\r\n      try {\r\n        response = await getStripe(cartTotal, cartProducts);\r\n      } catch (e) {\r\n        return this.setState({ session_error: true });\r\n      }\r\n\r\n      if (response.error) {\r\n        this.setState({ session_error: response.error });\r\n      } else {\r\n        this.setState({ client_secret: response.data });\r\n      }\r\n    }\r\n  }\r\n\r\n  handleSubmit = async (event) => {\r\n\r\n    event.preventDefault();\r\n\r\n    //set loading icon on button\r\n    this.setState({ buttonLoading: true });\r\n\r\n    const { stripe, elements, cartProducts, cartTotal } = this.props\r\n    const { name, phone, email, line1, city, state, zip, client_secret } = this.state;\r\n\r\n    if (!stripe || !elements) {\r\n      // Stripe.js has not yet loaded.\r\n      // Make  sure to disable form submission until Stripe.js has loaded.\r\n      return;\r\n    }\r\n\r\n    try {\r\n      const result = await stripe.confirmCardPayment(client_secret, {\r\n        payment_method: {\r\n          card: elements.getElement(CardElement),\r\n          billing_details: {\r\n            name: name,\r\n            phone: phone,\r\n            email: email\r\n          },\r\n        },\r\n        shipping: {\r\n          name: name,\r\n          phone: phone,\r\n          address: {\r\n            line1: line1,\r\n            city: city,\r\n            state: state,\r\n            postal_code: zip\r\n          }\r\n        }\r\n      });\r\n\r\n      if (result.error) {\r\n        this.setState({ payment_failed: true });\r\n      } else {\r\n        if (result.paymentIntent.status === 'succeeded') {\r\n\r\n          const response = await storeOrder(\r\n            result.paymentIntent,\r\n            cartProducts,\r\n            cartTotal,\r\n            name,\r\n            phone,\r\n            email);\r\n\r\n          if (response.data) {\r\n            sessionStorage.removeItem('cartTotal');\r\n            sessionStorage.removeItem('cartProducts');\r\n            this.setState({ order_completed: true, orderId: response.data.chargeId });\r\n          } else {\r\n            //failed to store order into database\r\n            //handle field to store order into the database\r\n            //It's already in stripe\r\n            //Send antoher request to database indicating it failed\r\n          }\r\n        } else {\r\n          //paymentIntent is something other than Succeed\r\n          //handle by sending something to our database or ignore\r\n        }\r\n      }\r\n    } catch (e) {\r\n      console.log(e);\r\n      this.setState({ session_error: true });\r\n    }\r\n  };\r\n\r\n  handleInputChange = (event) => {\r\n    const target = event.target;\r\n    const value = target.value;\r\n    const name = target.name;\r\n\r\n    this.setState({\r\n      [name]: value\r\n    });\r\n  }\r\n\r\n\r\n\r\n  render() {\r\n    const { name, phone, email, line1, city, state, zip, client_secret, session_error, order_completed, orderId, buttonLoading, payment_failed } = this.state;\r\n    const { cartTotal, cartProducts } = this.props;\r\n\r\n    if (order_completed) {\r\n      const descriptionOrderCompleted = `Your confirmation number is ${orderId}.\r\n      Check your email for details. If you have any questions or\r\n      concerns regarding your order please feel free to contact us.`;\r\n\r\n      return (\r\n        <Mymodal\r\n          showValue={true}\r\n          closeDirect='/'\r\n          buttonName='OK'\r\n          title={`Thank You ${name}!`}\r\n          description={descriptionOrderCompleted}\r\n          svgType=\"success\"\r\n        />\r\n      )\r\n    }\r\n\r\n    if (cartProducts.length <= 0) {\r\n      return (\r\n        <Mymodal\r\n          showValue={true}\r\n          closeDirect='/store'\r\n          buttonName='Store'\r\n          title='Cart Is Empty'\r\n          description='Go pick something from our store!'\r\n          svgType=\"empty\"\r\n        />\r\n      );\r\n    }\r\n\r\n    if (session_error) {\r\n      const clientErrorDescription = `Looks like something went wrong.\r\n      I apologize for the inconvience. No payment was taken`;\r\n      return (\r\n        <Mymodal\r\n          showValue={true}\r\n          closeDirect='/'\r\n          buttonName='Close'\r\n          title='Error'\r\n          description={clientErrorDescription}\r\n          svgType=\"error\"\r\n        />\r\n      );\r\n    }\r\n\r\n    if (client_secret === '') {\r\n      return <Spinner />;\r\n    }\r\n\r\n    if (payment_failed) {\r\n      const descriptionOrderFailed = \"Looks like your card has insufficient funds. No payment was taken.\";\r\n      return (\r\n        <Mymodal\r\n          showValue={true}\r\n          closeDirect='/store/checkout'\r\n          handleState={() => this.setState({ payment_failed: false, buttonLoading: false })}\r\n          buttonName='Try Again'\r\n          title='Payment Failed'\r\n          description={descriptionOrderFailed}\r\n          svgType=\"warning\"\r\n        />\r\n      )\r\n    }\r\n\r\n    const formatTotalPrice = formatPrice(\r\n      cartTotal.totalPrice,\r\n      cartTotal.currencyId\r\n    )\r\n\r\n    const formStuff = (\r\n      <>\r\n      {/* Testing Notification */}\r\n      <div className=\"alert alert-warning alert-dismissible fade show text-center\" role=\"alert\">\r\n        <strong>This is for testing purposes. Don't enter your credit card information. Use 4242 4242 4242 4242 04/24 4242 for a successful payment.</strong>\r\n        <button type=\"button\" className=\"close\" data-dismiss=\"alert\" aria-label=\"Close\">\r\n          <span aria-hidden=\"true\">&times;</span>\r\n        </button>\r\n      </div>\r\n      {/* Testing Notification End */}\r\n        <CartSection cartProducts={cartProducts} cartTotal={cartTotal} formatTotalPrice={formatTotalPrice} />\r\n        <form onSubmit={this.handleSubmit}>\r\n          <IdentitySection name={name} phone={phone} email={email} handleInputChange={this.handleInputChange} />\r\n          <AddressSection line1={line1} city={city} state={state} zip={zip} handleInputChange={this.handleInputChange} />\r\n          <CardSection />\r\n          <button className=\"btn btn-primary btn-block\" disabled={!this.props.stripe}>\r\n            {buttonLoading && <span className=\"spinner-border spinner-border-sm\" role=\"status\" aria-hidden=\"true\"></span>}\r\n                Confirm To Pay ${formatTotalPrice}\r\n          </button>\r\n        </form>\r\n      </>\r\n    );\r\n\r\n    const walletSvg = (\r\n      <svg className=\"bi bi-wallet\" style={{ position: 'relative', bottom: \"5px\" }} width=\"3rem\" height=\"3rem\" viewBox=\"0 0 20 20\" fill=\"currentColor\" xmlns=\"http://www.w3.org/2000/svg\">\r\n        <path fillRule=\"evenodd\" d=\"M3.5 5a.5.5 0 00-.5.5v2h5a.5.5 0 01.5.5c0 .253.08.644.306.958.207.288.557.542 1.194.542.637 0 .987-.254 1.194-.542.226-.314.306-.705.306-.958a.5.5 0 01.5-.5h5v-2a.5.5 0 00-.5-.5h-13zM17 8.5h-4.551a2.678 2.678 0 01-.443 1.042c-.393.546-1.043.958-2.006.958-.963 0-1.613-.412-2.006-.958A2.679 2.679 0 017.551 8.5H3v6a.5.5 0 00.5.5h13a.5.5 0 00.5-.5v-6zm-15-3A1.5 1.5 0 013.5 4h13A1.5 1.5 0 0118 5.5v9a1.5 1.5 0 01-1.5 1.5h-13A1.5 1.5 0 012 14.5v-9z\" clipRule=\"evenodd\">\r\n        </path>\r\n      </svg>\r\n    );\r\n\r\n    return (\r\n      <Modal show={true}\r\n        onHide={() => history.push('/store')}\r\n        aria-labelledby=\"contained-modal-title-vcenter\"\r\n        centered\r\n      >\r\n        <Modal.Header closeButton>\r\n          <Modal.Title>\r\n            <div className=\"row\">\r\n              {walletSvg}\r\n            </div>\r\n          </Modal.Title>\r\n        </Modal.Header>\r\n        <Modal.Body>{formStuff}</Modal.Body>\r\n      </Modal>\r\n    );\r\n\r\n  }\r\n}\r\n\r\nconst InjectedCheckoutForm = ({ cartProducts, cartTotal, clearCart, clearCartTotal }) => {\r\n  return (\r\n    <ElementsConsumer>\r\n      {({ stripe, elements }) => (\r\n        <CheckoutForm stripe={stripe}\r\n          elements={elements}\r\n          cartProducts={cartProducts}\r\n          cartTotal={cartTotal}\r\n          clearCart={clearCart}\r\n          clearCartTotal={clearCartTotal}\r\n        />\r\n      )}\r\n    </ElementsConsumer>\r\n  );\r\n\r\n};\r\n\r\nconst mapStateToProps = (state) => ({\r\n  cartTotal: state.total.data,\r\n  cartProducts: state.cart.products\r\n});\r\n\r\nexport default connect(mapStateToProps, { clearCart, clearCartTotal })(InjectedCheckoutForm);\r\n"]},"metadata":{},"sourceType":"module"}